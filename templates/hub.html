{% extends "base.html" %}
{% block content %}
<nav class="glass border-b border-cyan-900 p-4 sticky top-0 z-40 flex justify-between items-center">
    <div class="text-cyan-400 font-bold tracking-widest"><i class="fa-solid fa-network-wired"></i> OMNI.HUB</div>
    <div class="text-xs text-cyan-600">UNIT: {{ user.name }}</div>
</nav>

<div class="container mx-auto p-4 space-y-8 pb-20">

    <section class="glass sci-fi-border rounded-xl p-6 relative">
        <div class="absolute top-0 left-0 bg-cyan-500 text-black text-xs font-bold px-2 py-1">COMMAND: IGNITE</div>
        <h2 class="text-2xl font-bold text-white mb-4 mt-2">Parallel Engine Orchestration</h2>
        
        <div class="flex gap-4 mb-6">
            <input type="text" id="masterPrompt" class="flex-1 bg-black/50 border border-cyan-800 rounded p-4 text-cyan-100 focus:border-cyan-400 outline-none font-mono" placeholder="Enter prompt (e.g. Cyberpunk City, 8k render)...">
            <button onclick="igniteAllEngines()" class="btn-sci px-8 rounded font-bold flex items-center gap-2">
                <i class="fa-solid fa-burst"></i> IGNITE
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            
            <div class="sci-fi-border rounded-lg p-4 bg-black/40 flex flex-col">
                <h3 class="text-cyan-300 font-bold mb-2 text-sm"><i class="fa-solid fa-microchip"></i> ENGINE A: PUTER (FLUX)</h3>
                <div id="puterSlot" class="flex-1 min-h-[250px] bg-slate-900 rounded flex items-center justify-center relative border border-cyan-900/50">
                    <span class="text-cyan-700 text-xs">STANDBY</span>
                </div>
            </div>

            <div class="sci-fi-border rounded-lg p-4 bg-black/40 flex flex-col">
                <h3 class="text-pink-300 font-bold mb-2 text-sm"><i class="fa-solid fa-server"></i> ENGINE B: EVOLINK API</h3>
                <div id="evolinkSlot" class="flex-1 min-h-[250px] bg-slate-900 rounded flex items-center justify-center relative border border-pink-900/50">
                    <span class="text-pink-700 text-xs">STANDBY</span>
                </div>
            </div>

            <div class="sci-fi-border rounded-lg p-4 bg-black/40 flex flex-col">
                <h3 class="text-yellow-300 font-bold mb-2 text-sm"><i class="fa-solid fa-users-rays"></i> ENGINE C: AI HORDE (ASYNC)</h3>
                <div id="hordeSlot" class="flex-1 min-h-[250px] bg-slate-900 rounded flex items-center justify-center relative border border-yellow-900/50">
                    <span class="text-yellow-700 text-xs">STANDBY</span>
                </div>
            </div>

        </div>
        
        <div class="text-center mt-6">
            <button onclick="saveResults()" id="saveBtn" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-500 hidden">
                <i class="fa-solid fa-save"></i> SAVE GENERATED ASSETS
            </button>
        </div>
    </section>

    <section>
        <h3 class="text-cyan-500 border-b border-cyan-900 pb-2 mb-4 font-bold tracking-widest">ARCHIVE</h3>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            {% for item in history %}
            <a href="/history/{{ item.id }}" class="block sci-fi-border rounded-lg overflow-hidden hover:scale-105 transition relative aspect-square bg-black">
                <img src="{{ item.puter_image_url or item.evolink_image_url or item.horde_image_url }}" class="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition">
            </a>
            {% endfor %}
        </div>
    </section>

</div>

<script>
    let currentResults = { puter: null, evolink: null, horde: null };

    function setLoading(id) {
        document.getElementById(id).innerHTML = `<div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-8 w-8"></div>`;
    }

    function renderImg(id, url) {
        document.getElementById(id).innerHTML = `
            <img src="${url}" class="w-full h-full object-cover cursor-pointer" onclick="openFullscreen('${url}')">
        `;
    }

    async function igniteAllEngines() {
        const prompt = document.getElementById('masterPrompt').value;
        if(!prompt) return alert("Enter prompt");

        // Reset
        currentResults = { puter: null, evolink: null, horde: null };
        document.getElementById('saveBtn').classList.add('hidden');
        setLoading('puterSlot'); setLoading('evolinkSlot'); setLoading('hordeSlot');

        // 1. Puter.js (Frontend)
        puter.ai.txt2img(prompt, { model: 'flux.1-dev' })
            .then(r => { 
                currentResults.puter = r.src; 
                renderImg('puterSlot', r.src);
                checkSave();
            })
            .catch(e => document.getElementById('puterSlot').innerHTML = `<span class="text-red-500 text-xs">${e.message}</span>`);

        // 2. Evolink (Backend)
        fetch('/api/gen/evolink', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({prompt}) })
            .then(r => r.json())
            .then(d => {
                if(d.url) { currentResults.evolink = d.url; renderImg('evolinkSlot', d.url); checkSave(); }
                else document.getElementById('evolinkSlot').innerHTML = `<span class="text-gray-500 text-xs">${d.error}</span>`;
            });

        // 3. AI Horde (Backend Async)
        fetch('/api/gen/horde/start', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({prompt}) })
            .then(r => r.json())
            .then(d => {
                if(d.id) pollHorde(d.id);
                else document.getElementById('hordeSlot').innerHTML = `<span class="text-red-500 text-xs">${d.error}</span>`;
            });
    }

    function pollHorde(id) {
        let attempts = 0;
        const interval = setInterval(() => {
            attempts++;
            if(attempts > 30) { clearInterval(interval); document.getElementById('hordeSlot').innerHTML = "TIMEOUT"; return; }
            fetch(`/api/gen/horde/check/${id}`).then(r => r.json()).then(d => {
                if(d.status === 'done') {
                    clearInterval(interval);
                    currentResults.horde = d.url;
                    renderImg('hordeSlot', d.url);
                    checkSave();
                }
            });
        }, 2000);
    }

    function checkSave() {
        document.getElementById('saveBtn').classList.remove('hidden');
    }

    function saveResults() {
        const prompt = document.getElementById('masterPrompt').value;
        fetch('/api/save_final', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                prompt: prompt,
                puter_url: currentResults.puter,
                evolink_url: currentResults.evolink,
                horde_url: currentResults.horde
            })
        }).then(() => alert("Results Saved to Archive!"));
    }
</script>
{% endblock %}
